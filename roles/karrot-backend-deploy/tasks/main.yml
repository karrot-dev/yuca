---

- become_user: "{{ site }}-deploy"
  block:

  - set_fact:
      download_filename: "karrot-backend-{{ branch | regex_replace('[^a-zA-Z0-9.-]', '-') }}.pyz"

  - name: download karrot-backend
    get_url:
      url: 'https://download.karrot.world/{{ download_filename }}'
      dest: /var/www/{{ site }}/www/backend/karrot-backend.pyz
      mode: "u+rwx,a+x"

  - name: manage commands
    command: "./karrot-backend.pyz --env .env manage {{ item }}"
    args:
      chdir: "/var/www/{{ site }}/www/backend"
    with_items:
      - check --deploy
      - migrate
    changed_when: False

    # need to use 'sudo' to allow privileges just for this command
  - name: restart daphne
    shell: "sudo systemctl restart {{ site }}.target"
    changed_when: False

  - name: restart huey
    shell: "sudo systemctl restart {{ site }}-huey.service"
    changed_when: False